{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!--Post Display-->
        {% if user.is_authenticated %}
        {% for post in post_list|dictsortreversed:"created_on" %}
        <div class="col-md-6 offset-md-3 mt-4 card post" data-post-id="{{ post.id }}">
            <div class="card-body">
                <div class="author">{{ post.author }}</div>
                <div class="body">{{ post.body }}</div>
                <div class="created">{{ post.created_on }}</div>
            </div>
            <div class="card-footer bg-white">
                <!--Like Button-->
                <span class="post-likes-display">
                    <button class="btn btn-like">
                        {% if user in post.likes.all %}
                        <i class="fas fa-heart"></i>
                        {% else %}
                        <i class="far fa-heart"></i>
                        {% endif %}
                    </button>
                    <span class="text-secondary likes">{{ post.num_likes }}</span>
                </span>
                <!--Comments-->
                <span class="post-comments-display">
                    <i class="far fa-comment"></i>
                    <span class="text-secondary comments-count">{{ post.comments.count }}</span>
                </span>
                
                <!--Comment form-->
                <form id="create-comment-form">
                    {% csrf_token %}
                    <input type="hidden" id="post" name="post" value="{{ post.id }}">
                    <textarea id="body" name="body" placeholder="What's on your mind?" rows="4"></textarea>
                    <input type="submit" value="Post" class="btn post-btn"></input>
                </form>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <h2>You're not signed up</h2>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function () {
        // Handle like button
        $('.btn-like').click(function () {
            const postId = $(this).closest('.post').attr('data-post-id');
            // Send an AJAX request to the server to like the post
            $.ajax({
                url: '{% url "like_post" %}',
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                data: {
                    'post_id': postId,
                },
                success: function (data) {
                    let button = $('.post[data-post-id=' + postId + ']').find('.btn-like')
                    // Update number of likes
                    button.siblings('.likes').first()
                        .text(data.num_likes);
                    // Update like buton display
                    if (data.liked) {
                        button.html('<i class="fas fa-heart"></i>');
                    } else {
                        button.html('<i class="far fa-heart"></i>');
                    }
                }
            });
        });

        // Handle comment form submission
        $('#create-comment-form').submit(function (event) {
                event.preventDefault();
                const formData = new FormData(this);
                const csrfToken = formData.get('csrfmiddlewaretoken');
                const body = formData.get('body');
                const postId = formData.get('post');

                // Send an AJAX request to the server to create the post
                $.ajax({
                    url: '{% url "create_comment" %}',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                    },
                    data: {
                        'body': body,
                        'post_id': postId,
                    },
                    success: function (data) {
                        // Update comments number
                        $('.post[data-post-id=' + postId + ']').find('.comments-count')
                          .text(data.comments_count);
                        // Clear form
                        $('#create-comment-form').trigger('reset');
                        // Display comment
                    },
                });
            });
    });    
</script>
{% endblock %}